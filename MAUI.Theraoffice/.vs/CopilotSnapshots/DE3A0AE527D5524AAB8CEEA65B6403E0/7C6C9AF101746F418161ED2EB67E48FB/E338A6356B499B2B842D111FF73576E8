using System;
using System.Linq;
using System.Threading.Tasks;
using MAUI.Theraoffice.Models;
using MAUI.Theraoffice.Services;

namespace MAUI.Theraoffice.ViewModels
{
    public class AppointmentEditViewModel : BaseViewModel
    {
        private readonly IClinicStore _store;
        public Appointment Appointment { get; set; }
        public AppointmentEditViewModel(IClinicStore store, Appointment? a = null)
        {
            _store = store;
            Appointment = a ?? new Appointment
            {
                Start = DateTime.Today.AddHours(9),
                End = DateTime.Today.AddHours(9).AddMinutes(30)
            };
        }

        public Task<string?> SaveAsync()
        {
            if (Appointment.Id == Guid.Empty) Appointment.Id = Guid.NewGuid();
            return _store.GetAppointmentAsync(Appointment.Id).ContinueWith<Task<string?>>(t =>
            {
                if (t.Result is null) return _store.TryAddAppointmentAsync(Appointment);
                return _store.TryUpdateAppointmentAsync(Appointment);
            }).Unwrap();
        }
    }
}
